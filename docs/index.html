<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>German Vocab Trainer — Fixed UI</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0b1220;
      --card: rgba(255, 255, 255, 0.226);
      --muted: #01050c;
      --accent1: #87adfe;
      --accent2: #ff77cd;
      --accent-grad: linear-gradient(90deg,var(--accent1),var(--accent2));
      --success: #22c55e;
      --danger: #ef4444;
      --glass: rgba(255, 255, 255, 0);
      --text: #fff;
      --soft: rgba(24, 5, 5, 0.06);
      --card-strong: rgba(255,255,255,0.06);
      --input-bg: rgba(255, 255, 255, 0.39);
    }

    [data-theme="light"]{
      --bg: #a8c8dd;
      --card: rgba(35, 71, 143, 0.137);
      --muted:#fff;
      --accent1: #4f46e5;
      --accent2: #fff;
      --accent-grad: linear-gradient(90deg,var(--accent1),var(--accent2));
      --success: #16a34a;
      --danger: #dc2626;
      --glass: rgba(66, 207, 218, 0.6);
      --text: #030000;
      --soft: rgba(7,16,40,0.04);
      --card-strong: rgba(185, 188, 196, 0.432);
      --input-bg: rgba(255,255,255,0.95);
      
    }
    [data-theme="light"] body {background: linear-gradient(70deg, var(--bg) 0%, #80648b 70%, #e6f0fa 100%); color: var(--text);}

    *{box-sizing:border-box;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;padding:0}
    html,body{height:150%}
    body{
      background: linear-gradient(70deg,var(--bg), 0%, #8b6eb1 70%, #2a1941); 
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      line-height:1.4;
    }

    .container{max-width:1200px;margin:0 auto;padding:20px}
    /* Extra mobile responsiveness */
    @media(max-width:40px){
    .grid{ grid-template-columns:1fr !important; }
    .word-large{ font-size:28px !important; }
    .mcq-grid{ grid-template-columns:1fr !important; }
    .panel, .card-big{ padding:12px !important; }
    .btn, .select, .input{ font-size:15px; padding:10px; }
    .nav{ flex-wrap:wrap; gap:6px; }
    .nav-links{ flex-wrap:wrap; }}

    /* NAV */
    .nav{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px; border-radius:0px; background:linear-gradient(70deg,var(--bg), 0%, #735399 70%, #967bbd 100%); border:1px solid var(--soft); position: fixed; top: 0; left: 0; width: 100%; z-index: 999;}
    .logo{display:flex;gap:12px;align-items:center}
    .logo .mark{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:500;color:#01050c}
    .nav-links{display:flex;gap:8px;align-items:center}
    a.nav-link{color:var(--text);text-decoration:none;padding:8px 10px;border-radius:8px;font-weight:300}
    a.nav-link:hover{background:var(--card-strong)}
    .theme-btn{padding:8px 10px;border-radius:8px;border:1px solid var(--soft);background:transparent;cursor:pointer;color:var(--text)}
    
    /* layout */
    .grid{display:grid;grid-template-columns:340px 1fr;gap:18px;margin-top:80px}
    @media(max-width:980px){ .grid{grid-template-columns:1fr;padding:0 12px} }

    /* SIDEBAR */
    .panel{background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--soft)}
    .panel h3{margin-bottom:8px}
    .select, .input, select, input, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--soft);background:var(--input-bg);color:var(--text);margin-top:6px;font-size:15px}
    .btn{padding:10px 14px;border-radius:10px;border:none;background:var(--accent-grad);color:#fff;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid var(--soft);color:var(--text)}
    .small{font-size:13px;color:var(--muted)}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--glass);font-weight:300;color:var(--text)}

    /* trainer */
    .card-big{padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid var(--soft)}
    .word-large{font-size:44px;font-weight:300;letter-spacing:0.4px;text-align:center;word-break:break-word}
    .meaning{font-size:18px;color:var(--muted);margin-top:8px;text-align:center}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;justify-content:center}
    .progress-wrap{height:12px;border-radius:999px;background:var(--soft);overflow:hidden;margin-top:12px}
    .progress{height:100%;width:0;background:linear-gradient(90deg,var(--accent2),var(--accent1));transition:width 0.9s}

    .mcq-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:19px}
    @media(max-width:640px){ .mcq-grid{grid-template-columns:1fr} }
    .opt{padding:12px;border-radius:10px;border:1px solid var(--soft);cursor:pointer;background:transparent}
    .opt.correct{background:rgba(34, 197, 94, 0.199);border-color:rgba(34,197,94,0.28)}
    .opt.wrong{background:rgba(239,68,68,0.08);border-color:rgba(239,68,68,0.18)}

    .keys{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}
    .key{padding:8px 10px;border-radius:8px;background:transparent;border:1px solid var(--soft);cursor:pointer;font-weight:700;color:var(--text)}

    .table-wrap{max-height:480px;overflow:auto;border-radius:8px;border:1px solid var(--soft);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:8px;margin-top:10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:14px;color:var(--text)}
    th{font-weight:700;color:var(--muted);background:transparent}
    .play-btn{cursor:pointer;padding:6px 10px;border-radius:8px;border:1px solid var(--soft);background:transparent;color:var(--text)}

    .rev-pagination{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px}

    footer{margin-top:22px;text-align:center;color:var(--muted);font-size:13px}

    /* style select to avoid white boxes on Windows */
    select { -webkit-appearance: none; appearance:none; background-image: linear-gradient(45deg, transparent 50%, var(--text) 50%), linear-gradient(135deg, var(--text) 50%, transparent 50%); background-position: calc(100% - 20px) calc(1em + 1px), calc(100% - 15px) calc(1em + 1px); background-size: 6px 6px, 6px 6px; background-repeat: no-repeat; padding-right:36px; }

    select option { background: var(--bg); color: var(--text); }

    @media(max-width:540px){
      .word-large{font-size:28px}
    }
  </style>
</head>
<body>

  <div class="container">

    <!-- NAV -->
    <div class="nav">
      <div class="logo">
        <div class="mark">GV</div>
        <div>
          <div style="font-weight:700">VocabTrainer</div>
          <div class="small">German A1 → C2</div>
        </div>
      </div>

      <div class="nav-links">
        <a class="nav-link" href="#trainer" onclick="scrollToSection('trainer')">Trainer</a>
        <a class="nav-link" href="#revision" onclick="scrollToSection('revision')">Revision</a>
        <a class="nav-link" href="#import" onclick="scrollToSection('import')">Import</a>
        <a class="nav-link" href="#contact" onclick="scrollToSection('contact')">Contact</a>
        <button id="themeBtn" class="theme-btn" title="Toggle theme">🌙</button>
      </div>
    </div>

    <div class="grid">

      <!-- SIDEBAR -->
      <div class="panel">
        <h3>Controls</h3>

        <div style="margin-top:8px">
          <label class="small">Level</label>
          <select id="levelSelect" class="select">
            <option value="ALL">All</option>
            <option value="A1">A1</option><option value="A2">A2</option>
            <option value="B1">B1</option><option value="B2">B2</option>
            <option value="C1">C1</option><option value="C2">C2</option>
            <option value="OTHERS">Others</option>
          </select>
        </div>

        <div style="margin-top:10px">
          <label class="small">Mode</label>
          <select id="modeSelect" class="select">
            <option value="flash">Flashcards</option>
            <option value="mcq">Multiple Choice</option>
            <option value="type">Typing</option>
          </select>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="startBtn" class="btn">Start</button>
          <button id="shuffleBtn" class="btn ghost">Shuffle</button>
        </div>

        <div style="margin-top:12px">
          <div class="small">Session</div>
          <div class="progress-wrap" style="margin-top:8px"><div id="mainProgress" class="progress"></div></div>
          <div id="progressText" class="small" style="margin-top:8px">0 / 0 • ✓ 0</div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid var(--soft)">

        <div>
          <h4 style="margin:6px 0">Multiple CSV upload</h4>
          <div class="small">Choose CSV files. Header supported: Level,Article,German,Plural,English</div>
          <input id="multiFiles" type="file" accept=".csv,.txt" multiple style="margin-top:8px" />
          <select id="uploadLevel" class="select" style="margin-top:8px">
            <option value="AUTO">Auto-detect (from filename)</option>
            <option value="A1">A1</option><option value="A2">A2</option>
            <option value="B1">B1</option><option value="B2">B2</option>
            <option value="C1">C1</option><option value="C2">C2</option>
            <option value="OTHERS">Others</option>
          </select>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="uploadBtn" class="btn">Upload</button>
            <button id="downloadTemplate" class="btn ghost">Download Template</button>
          </div>
          <div id="uploadStatus" class="small" style="margin-top:8px">No uploads yet</div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid var(--soft)">

        <div>
          <h4 style="margin:6px 0">Dataset</h4>
          <div style="display:flex;gap:8px">
            <button id="exportBtn" class="btn ghost">Export CSV</button>
            <button id="clearBtn" class="btn ghost">Clear All</button>
            <button id="resetProgressBtn" class="btn ghost">Reset Progress</button>
          </div>
          <div id="datasetInfo" class="small" style="margin-top:8px">Saved locally in your browser</div>
        </div>
      </div>

      <!-- MAIN COLUMN -->
      <div>

        <!-- TRAINER -->
        <section id="trainer" class="card-big">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <div>
              <h2 style="margin:0">Trainer</h2>
              <div class="small">Practice flashcards, MCQ, typing</div>
            </div>
            <div style="text-align:right">
              <div class="small">Level</div>
              <div class="badge" id="currentLevelBadge">ALL</div>
            </div>
          </div>

          <div style="margin-top:14px">
            <div class="word-large" id="displayWord">No words loaded</div>
            <div class="meaning" id="displayMeaning"></div>

            <div id="actionArea" style="margin-top:10px;display:flex;flex-direction:column;gap:8px"></div>

            <!-- typing area -->
            <div id="typingBox" style="display:none;margin-top:12px">
              <input id="typingInput" class="input" placeholder="Type the article + word (e.g. der Hund)" autocomplete="off" />
              <div class="keys" id="specialKeys"></div>
              <div style="display:flex;gap:8px;margin-top:10px;justify-content:center">
                <button id="typingCheck" class="btn">Check</button>
                <button id="typingReveal" class="btn ghost">Reveal</button>
              </div>
              <div id="typingFeedback" class="small" style="margin-top:8px"></div>
            </div>

            <div class="progress-wrap" style="margin-top:12px"><div id="sessionProgress" class="progress" style="width:0%"></div></div>
            <div class="small" id="sessionText" style="margin-top:8px">0 / 0 • ✓ 0</div>
          </div>
        </section>

        <!-- REVISION -->
        <section id="revision" class="panel" style="margin-top:14px">
          <h2 style="margin-top:0">Revision 📖</h2>
          <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
            <input id="revSearch" class="input" placeholder="Search German or English..." style="flex:1" />
            <select id="revLevel" class="select" style="width:160px">
              <option value="ALL">All</option>
              <option value="A1">A1</option><option value="A2">A2</option>
              <option value="B1">B1</option><option value="B2">B2</option>
              <option value="C1">C1</option><option value="C2">C2</option>
              <option value="OTHERS">Others</option>
            </select>
            <button id="revRefresh" class="btn ghost">Refresh</button>
          </div>

          <div class="table-wrap">
            <table aria-live="polite">
              <thead><tr><th>Lvl</th><th>Article</th><th>German</th><th>Plural</th><th>English</th><th>🔊</th></tr></thead>
              <tbody id="revBody"></tbody>
            </table>
          </div>

          <div class="rev-pagination">
            <button id="revPrev" class="btn ghost">Prev</button>
            <div id="revPageInfo" class="small muted">Page 1 / 1</div>
            <button id="revNext" class="btn ghost">Next</button>
          </div>
        </section>

        <!-- IMPORT single -->
        <section id="import" class="panel" style="margin-top:14px">
          <h2 style="margin-top:0">Import / Single file</h2>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="singleFile" type="file" accept=".csv" />
            <select id="singleAssign" class="select" style="width:160px">
              <option value="AUTO">Auto-detect</option>
              <option value="A1">A1</option><option value="A2">A2</option>
              <option value="B1">B1</option><option value="B2">B2</option>
              <option value="C1">C1</option><option value="C2">C2</option>
              <option value="OTHERS">Others</option>
            </select>
            <button id="singleUploadBtn" class="btn">Upload</button>
          </div>
          <div id="singleStatus" class="small" style="margin-top:8px"></div>
        </section>

        <!-- CONTACT -->
        <section id="contact" class="panel" style="margin-top:14px">
          <h2 style="margin-top:0">Contact</h2>
          <div class="small">Messages saved locally. Connect EmailJS later to send emails.</div>
          <div style="margin-top:8px">
            <input id="contactName" placeholder="Name" class="input" />
            <input id="contactEmail" placeholder="Email" class="input" style="margin-top:8px" />
            <textarea id="contactMessage" placeholder="Message" class="input" style="margin-top:8px;min-height:120px"></textarea>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="contactSend" class="btn">Send (demo)</button>
              <button id="contactSave" class="btn ghost">Save Locally</button>
            </div>
            <div id="contactStatus" class="small" style="margin-top:8px"></div>
          </div>
        </section>

      </div>
    </div>

    <footer>Built for learning • Data stored in browser localStorage</footer>
  </div>

  <script>
  /* ----------------- Constants & localStorage keys ----------------- */
  const LS_WORDS = 'gvt_words_v5';
  const LS_PROG = 'gvt_prog_v5';
  const LS_THEME = 'gvt_theme_v5';
  const LS_MESSAGES = 'gvt_messages_v5';

  /* ----------------- Utility ----------------- */
  function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,9); }
  function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function loadJSON(k, d=null){ try{ const s = localStorage.getItem(k); return s ? JSON.parse(s) : d; } catch(e){ return d; } }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
  function normalizeCmp(s){ return (s||'').toString().trim().normalize('NFC').toLowerCase(); }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

  /* ----------------- App state ----------------- */
  let allWords = loadJSON(LS_WORDS, []);          // {id, Level, Article, German, Plural, English}
  let progress = loadJSON(LS_PROG, {correct:0,seen:0,per:{}});

  // DOM refs
  const levelSelect = document.getElementById('levelSelect');
  const modeSelect = document.getElementById('modeSelect');
  const startBtn = document.getElementById('startBtn');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const mainProgress = document.getElementById('mainProgress');
  const progressText = document.getElementById('progressText');
  const currentLevelBadge = document.getElementById('currentLevelBadge');

  const displayWord = document.getElementById('displayWord');
  const displayMeaning = document.getElementById('displayMeaning');
  const actionArea = document.getElementById('actionArea');
  const typingBox = document.getElementById('typingBox');
  const typingInput = document.getElementById('typingInput');
  const typingFeedback = document.getElementById('typingFeedback');
  const specialKeys = document.getElementById('specialKeys');
  const sessionProgress = document.getElementById('sessionProgress');
  const sessionText = document.getElementById('sessionText');

  // import / upload
  const multiFiles = document.getElementById('multiFiles');
  const uploadBtn = document.getElementById('uploadBtn');
  const uploadLevel = document.getElementById('uploadLevel');
  const uploadStatus = document.getElementById('uploadStatus');
  const downloadTemplate = document.getElementById('downloadTemplate');
  const exportBtn = document.getElementById('exportBtn');
  const clearBtn = document.getElementById('clearBtn');
  const resetProgressBtn = document.getElementById('resetProgressBtn');

  // single upload
  const singleFile = document.getElementById('singleFile');
  const singleAssign = document.getElementById('singleAssign');
  const singleUploadBtn = document.getElementById('singleUploadBtn');
  const singleStatus = document.getElementById('singleStatus');

  // revision
  const revSearch = document.getElementById('revSearch');
  const revLevel = document.getElementById('revLevel');
  const revBody = document.getElementById('revBody');
  const revPrev = document.getElementById('revPrev');
  const revNext = document.getElementById('revNext');
  const revPageInfo = document.getElementById('revPageInfo');
  const revRefresh = document.getElementById('revRefresh');

  // contact
  const contactName = document.getElementById('contactName');
  const contactEmail = document.getElementById('contactEmail');
  const contactMessage = document.getElementById('contactMessage');
  const contactSave = document.getElementById('contactSave');
  const contactSend = document.getElementById('contactSend');
  const contactStatus = document.getElementById('contactStatus');

  const themeBtn = document.getElementById('themeBtn');

  /* session */
  let pool = [];         // filtered session items
  let mode = 'flash';    // flash, mcq, type
  let idx = 0;
  let sessionCorrect = 0;
  const REV_PAGE_SIZE = 50;
  let revPage = 1;

  /* ----------------- Init ----------------- */
  function saveAll(){ saveJSON(LS_WORDS, allWords); document.getElementById('datasetInfo').textContent = `Saved: ${allWords.length} words (local)`; }
  function saveProg(){ saveJSON(LS_PROG, progress); }

  // theme
  let currentTheme = localStorage.getItem(LS_THEME) || 'dark';
  function applyTheme(t){
    document.documentElement.setAttribute('data-theme', t === 'light' ? 'light' : 'dark');
    themeBtn.textContent = t === 'light' ? '🌞' : '🌙';
    localStorage.setItem(LS_THEME, t);
  }
  applyTheme(currentTheme);
  themeBtn.addEventListener('click', ()=> { currentTheme = (currentTheme==='dark') ? 'light' : 'dark'; applyTheme(currentTheme); });

  // initial UI updates
  saveAll();
  renderRevPage();

  /* ----------------- CSV parsing helpers ----------------- */
  function csvSplit(line){
    const arr=[]; let cur=''; let inQuotes=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"'){ inQuotes = !inQuotes; continue; }
      if(ch === ',' && !inQuotes){ arr.push(cur); cur=''; continue; }
      cur += ch;
    }
    arr.push(cur);
    return arr.map(x => x.trim());
  }

  // parse full text in chunks but detect header once
  async function parseCSVText(text, onProgress){
    if(!text) return [];
    if(text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    const lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
    if(lines.length===0) return [];
    // detect header on first line
    const firstCols = csvSplit(lines[0]).map(h => h.toLowerCase());
    const hasHeader = firstCols.includes('german') && firstCols.includes('english'); // require minimal columns
    const headerCols = hasHeader ? firstCols : null;
    const startIndex = hasHeader ? 1 : 0;
    const chunkSize = 2000;
    const result = [];
    for(let i=startIndex;i<lines.length;i+=chunkSize){
      const slice = lines.slice(i, i+chunkSize);
      for(const ln of slice){
        if(!ln || !ln.trim()) continue;
        const cols = csvSplit(ln);
        let rec={};
        if(hasHeader){
          rec.Level = cols[headerCols.indexOf('level')] || '';
          rec.Article = cols[headerCols.indexOf('article')] || '';
          rec.German = cols[headerCols.indexOf('german')] || '';
          rec.Plural = cols[headerCols.indexOf('plural')] || '';
          rec.English = cols[headerCols.indexOf('english')] || '';
        } else {
          rec.Level = cols[0] || '';
          rec.Article = cols[1] || '';
          rec.German = cols[2] || '';
          rec.Plural = cols[3] || '';
          rec.English = cols[4] || '';
        }
        // skip invalid rows
        if(!(rec.German && rec.English)) continue;
        // skip accidental header-like rows
        if(rec.German.toLowerCase()==='german' && rec.English.toLowerCase()==='english') continue;
        result.push(rec);
      }
      if(onProgress) onProgress(Math.min(lines.length, i+chunkSize), lines.length);
      // yield to UI so browser doesn't block
      await sleep(0);
    }
    return result;
  }

  /* ----------------- Upload handlers ----------------- */
  uploadBtn.addEventListener('click', async ()=>{
    const files = Array.from(multiFiles.files || []);
    if(files.length === 0){ uploadStatus.textContent = 'No files selected'; return; }
    uploadStatus.textContent = 'Processing...';
    let totalAdded = 0;
    for(const f of files){
      try{
        const text = await f.text();
        const rows = await parseCSVText(text, (p,t)=> uploadStatus.textContent = `Parsing ${f.name}: ${p}/${t} lines`);
        let assign = uploadLevel.value || 'AUTO';
        let lvl = assign;
        if(assign === 'AUTO'){
          const name = (f.name || '').toUpperCase();
          const found = ['A1','A2','B1','B2','C1','C2'].find(x => name.includes(x));
          lvl = found || 'OTHERS';
        }
        const prepared = rows.map(r => ({
          id: uid(),
          Level: (r.Level || lvl || '').toString().toUpperCase(),
          Article: r.Article || '',
          German: r.German || '',
          Plural: r.Plural || '',
          English: r.English || ''
        })).filter(r => r.German && r.English);
        allWords = allWords.concat(prepared);
        totalAdded += prepared.length;
        saveAll();
        await sleep(80);
      } catch(err){
        console.error('file parse err', err);
      }
    }
    rebuildPool(); renderRevPage(); updateSessionUI();
    uploadStatus.textContent = `Imported ${totalAdded} rows from ${files.length} file(s)`;
  });

  downloadTemplate.addEventListener('click', ()=>{
    const sample = 'Level,Article,German,Plural,English\nA1,der,Hund,Hunde,dog\nA1,die,Katze,Katzen,cat\n';
    const blob = new Blob([sample], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'vocab_template.csv'; a.click(); URL.revokeObjectURL(url);
  });

  singleUploadBtn.addEventListener('click', async ()=>{
    const f = singleFile.files[0];
    if(!f){ singleStatus.textContent = 'Select a file first'; return; }
    singleStatus.textContent = 'Processing...';
    try{
      const text = await f.text();
      const rows = await parseCSVText(text, (p,t)=> singleStatus.textContent = `Parsing ${f.name}: ${p}/${t}`);
      let assign = singleAssign.value || 'AUTO';
      let lvl = assign;
      if(assign === 'AUTO'){
        const name = (f.name || '').toUpperCase();
        const found = ['A1','A2','B1','B2','C1','C2'].find(x => name.includes(x));
        lvl = found || 'OTHERS';
      }
      const prepared = rows.map(r=>({ id: uid(), Level: (r.Level||lvl).toUpperCase(), Article: r.Article||'', German: r.German||'', Plural: r.Plural||'', English: r.English||'' })).filter(r=>r.German && r.English);
      allWords = allWords.concat(prepared);
      saveAll();
      rebuildPool(); renderRevPage(); updateSessionUI();
      singleStatus.textContent = `Imported ${prepared.length} rows assigned to ${lvl}`;
    }catch(e){
      console.error(e);
      singleStatus.textContent = 'Error reading file';
    }
  });

  /* Export / Clear / Reset */
  exportBtn.addEventListener('click', ()=>{
    const header = 'Level,Article,German,Plural,English\n';
    const body = allWords.map(r => {
      const fields = [r.Level || '', r.Article || '', r.German || '', r.Plural || '', r.English || ''];
      return fields.map(f => /[",\n]/.test(f) ? '"' + f.replace(/"/g,'""') + '"' : f).join(',');
    }).join('\n');
    const blob = new Blob([header + body], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'german_vocab_export.csv'; a.click(); URL.revokeObjectURL(url);
  });

  clearBtn.addEventListener('click', ()=>{
    if(!confirm('Clear ALL words from local storage?')) return;
    allWords = []; saveAll(); rebuildPool(); renderRevPage(); renderCurrent();
  });

  resetProgressBtn.addEventListener('click', ()=>{
    if(!confirm('Reset stored progress?')) return;
    progress = {correct:0, seen:0, per:{}}; saveProg(); sessionCorrect = 0; updateSessionUI();
  });

  /* ----------------- Pool & Trainer logic ----------------- */
  function rebuildPool(){
    const lv = (levelSelect.value || 'ALL');
    currentLevelBadge.textContent = lv;
    pool = (lv === 'ALL') ? allWords.slice() : allWords.filter(w => (w.Level || '').toUpperCase() === lv);
    idx = 0; sessionCorrect = 0; updateSessionUI();
  }

  function updateSessionUI(){
    const total = pool.length;
    const pct = total ? Math.round((sessionCorrect / total) * 100) : 0;
    sessionProgress.style.width = pct + '%';
    sessionText.textContent = `${Math.min(idx,total)} / ${total} • ✓ ${sessionCorrect}`;
    mainProgress.style.width = pct + '%';
    progressText.textContent = `${Math.min(idx,total)} / ${total} • ✓ ${sessionCorrect}`;
  }

  startBtn.addEventListener('click', ()=> {
    mode = modeSelect.value || 'flash';
    rebuildPool();
    if(pool.length === 0){ alert('No words loaded. Import CSV first.'); renderCurrent(); return; }
    pool = shuffle(pool.slice());
    idx = 0; sessionCorrect = 0; updateSessionUI();
    renderCurrent();
  });

  shuffleBtn.addEventListener('click', ()=> {
    pool = shuffle(pool.slice()); idx = 0; sessionCorrect = 0; updateSessionUI(); renderCurrent();
  });

  function renderCurrent(){
    updateSessionUI();
    if(pool.length === 0){
      displayWord.textContent = 'No words loaded. Please upload CSV.';
      displayMeaning.textContent = '';
      actionArea.innerHTML = '';
      typingBox.style.display = 'none';
      return;
    }
    if(idx >= pool.length){
      displayWord.textContent = 'Session finished 🎉';
      displayMeaning.textContent = '';
      actionArea.innerHTML = `<div style="text-align:center"><button class="btn" id="restartBtn">Restart</button></div>`;
      typingBox.style.display = 'none';
      document.getElementById('restartBtn').addEventListener('click', ()=> { idx = 0; sessionCorrect = 0; renderCurrent(); });
      return;
    }

    const w = pool[idx];
    // show article in front (user wanted article visible)
    if(mode === 'type'){
      displayWord.textContent = w.English || '[missing English]';
    } else {
      displayWord.textContent = ((w.Article || '').trim() ? (w.Article + ' ') : '') + w.German;
    }
    displayMeaning.textContent = '';
    typingBox.style.display = (mode === 'type') ? 'block' : 'none';
    typingInput.value = '';
    typingFeedback.textContent = '';
    actionArea.innerHTML = '';

    if(mode === 'flash') renderFlash(w);
    if(mode === 'mcq') renderMCQ(w);
    if(mode === 'type') renderType(w);
  }

  /* Flash */
  function renderFlash(w){
    const wrapper = document.createElement('div');
    wrapper.className = 'actions';
    const flip = document.createElement('button'); flip.className='btn'; flip.textContent='Show meaning';
    const knew = document.createElement('button'); knew.className='btn ghost'; knew.textContent='I knew it';
    const dont = document.createElement('button'); dont.className='btn ghost'; dont.textContent="I need practice";
    const next = document.createElement('button'); next.className='btn ghost'; next.textContent='Next';
    const speakBtn = document.createElement('button'); speakBtn.className='btn ghost'; speakBtn.textContent='🔊';

    flip.addEventListener('click', ()=> { displayMeaning.textContent = w.English + (w.Plural ? ' • Plural: ' + w.Plural : ''); });
    knew.addEventListener('click', ()=> { sessionCorrect++; progress.correct = (progress.correct||0) + 1; progress.per[w.id] = (progress.per[w.id]||0) + 1; saveProg(); idx++; renderCurrent(); });
    dont.addEventListener('click', ()=> { idx++; renderCurrent(); });
    next.addEventListener('click', ()=> { idx++; renderCurrent(); });
    speakBtn.addEventListener('click', ()=> speak(((w.Article||'') + ' ' + w.German).trim()));

    wrapper.appendChild(flip); wrapper.appendChild(knew); wrapper.appendChild(dont); wrapper.appendChild(next); wrapper.appendChild(speakBtn);
    actionArea.appendChild(wrapper);
  }

  /* MCQ */
  function renderMCQ(w){
    const opts = new Set([w.English]);
    let attempts = 0;
    while(opts.size < 4 && attempts < 200 && allWords.length > 0){
      const r = allWords[Math.floor(Math.random() * allWords.length)].English;
      if(r) opts.add(r);
      attempts++;
    }
    const arr = shuffle(Array.from(opts));
    const grid = document.createElement('div'); grid.className='mcq-grid';
    arr.forEach(opt => {
      const d = document.createElement('div'); d.className='opt'; d.textContent = opt;
      d.addEventListener('click', ()=>{
        if(d.classList.contains('answered')) return;
        d.classList.add('answered');
        if(opt === w.English){
          d.classList.add('correct'); sessionCorrect++; progress.correct = (progress.correct||0)+1; progress.per[w.id] = (progress.per[w.id]||0)+1; saveProg();
        } else {
          d.classList.add('wrong');
          Array.from(grid.children).forEach(c => { if(c.textContent === w.English) c.classList.add('correct'); });
        }
        idx++; updateSessionUI();
        setTimeout(()=> renderCurrent(), 800);
      });
      grid.appendChild(d);
    });
    actionArea.appendChild(grid);
  }

  /* Typing */
  function buildSpecialKeys(){
    specialKeys.innerHTML = '';
    const keys = ["ä","ö","ü","Ä","Ö","Ü","ß"];
    keys.forEach(ch => {
      const b = document.createElement('button'); b.type='button'; b.className='key'; b.textContent=ch;
      b.addEventListener('click', ()=> {
        const el = typingInput;
        const s = el.selectionStart || 0, e = el.selectionEnd || 0;
        el.value = el.value.slice(0,s) + ch + el.value.slice(e);
        el.focus(); el.selectionStart = el.selectionEnd = s + ch.length;
      });
      specialKeys.appendChild(b);
    });
  }

  function renderType(w){
    buildSpecialKeys();
    // action area can show prompt info
    const info = document.createElement('div'); info.className='small'; info.textContent = 'Type the German form including article (e.g. der Hund). Case-insensitive.';
    actionArea.appendChild(info);
  }

  document.getElementById('typingCheck').addEventListener('click', ()=>{
    if(pool.length === 0) return;
    const w = pool[idx];
    const expected = ((w.Article || '') + ' ' + (w.German || '')).trim().normalize('NFC');
    const val = (typingInput.value || '').trim().normalize('NFC');
    // check against main + synonyms (same English meaning)
    const synonyms = allWords.filter(x => normalizeCmp(x.English) === normalizeCmp(w.English));
    const accepted = synonyms.map(x => ((x.Article||'') + ' ' + (x.German||'')).trim());

    if(accepted.some(ans => normalizeCmp(val) === normalizeCmp(ans))){
    typingFeedback.innerHTML = `<span style="color:var(--success)">✅ Correct</span>`;
    sessionCorrect++;
    progress.correct = (progress.correct||0)+1;
    progress.per[w.id] = (progress.per[w.id]||0)+1;
    saveProg();
    } else {
    typingFeedback.innerHTML = `<span style="color:var(--danger)">❌ Wrong</span> — Correct options: <b>${accepted.join(' | ')}</b>`;
    if(w.Plural) typingFeedback.innerHTML += ` • Plural: ${escapeHtml(w.Plural)}`;
   }

    idx++; updateSessionUI();
    setTimeout(()=> renderCurrent(), 900);
  });

  document.getElementById('typingReveal').addEventListener('click', ()=>{
    if(pool.length === 0) return;
    const w = pool[idx];
    typingFeedback.textContent = ((w.Article || '') + ' ' + w.German + (w.Plural ? ' • Plural: ' + w.Plural : '')).trim();
    typingFeedback.style.color = 'var(--muted)';
  });

  // keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if(e.code === 'Space' && mode === 'flash'){ e.preventDefault(); const flip = actionArea.querySelector('.btn'); if(flip) flip.click(); }
    if(mode === 'mcq' && ['Digit1','Digit2','Digit3','Digit4'].includes(e.code)){
      const n = Number(e.code.slice(-1)) - 1; const opts = document.querySelectorAll('.mcq-grid .opt'); if(opts[n]) opts[n].click();
    }
    if(mode === 'type' && e.key === 'Enter'){ e.preventDefault(); document.getElementById('typingCheck').click(); }
  });

  /* speak TTS */
  function speak(text){
    if(!text) return;
    try{const u = new SpeechSynthesisUtterance(text);
    u.lang = 'de-DE';
    u.rate = 0.95;
    // iOS fix: choose a German voice if available
    const voices = speechSynthesis.getVoices();
    const germanVoice = voices.find(v => v.lang.startsWith('de'));
    if(germanVoice) u.voice = germanVoice;
    speechSynthesis.cancel(); // stop overlap
    speechSynthesis.speak(u);
    }catch(e){ console.error('TTS error', e); }}
  // toggle TTS not added to UI now but speak used on buttons

  /* ----------------- Revision (pagination 50) ----------------- */
  function getFilteredRows(){
    const q = (revSearch.value||'').toLowerCase().trim();
    const lvl = (revLevel.value || 'ALL');
    return allWords.filter(r=>{
      if(lvl !== 'ALL' && (r.Level||'').toUpperCase() !== lvl) return false;
      if(!q) return true;
      return ((r.German||'') + ' ' + (r.English||'')).toLowerCase().includes(q);
    });
  }

  function renderRevPage(){
    const rows = getFilteredRows();
    const total = rows.length;
    const totalPages = Math.max(1, Math.ceil(total / REV_PAGE_SIZE));
    if(revPage > totalPages) revPage = totalPages;
    const start = (revPage - 1) * REV_PAGE_SIZE;
    const pageRows = rows.slice(start, start + REV_PAGE_SIZE);

    revBody.innerHTML = '';
    for(const r of pageRows){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escapeHtml(r.Level||'')}</td>
        <td>${escapeHtml(r.Article||'')}</td>
        <td>${escapeHtml(r.German||'')}</td>
        <td>${escapeHtml(r.Plural||'')}</td>
        <td>${escapeHtml(r.English||'')}</td>
        <td><button class="play-btn">🔊</button></td>`;
      tr.querySelector('.play-btn').addEventListener('click', ()=> speak(((r.Article||'') + ' ' + r.German).trim()));
      revBody.appendChild(tr);
    }
    revPageInfo.textContent = `Page ${revPage} / ${totalPages} (${total} words)`;
    revPrev.disabled = revPage <= 1;
    revNext.disabled = revPage >= totalPages;
  }

  revSearch.addEventListener('input', ()=> { revPage = 1; renderRevPage(); });
  revLevel.addEventListener('change', ()=> { revPage = 1; renderRevPage(); });
  revRefresh.addEventListener('click', ()=> { revPage = 1; renderRevPage(); });
  revPrev.addEventListener('click', ()=> { if(revPage>1){ revPage--; renderRevPage(); }});
  revNext.addEventListener('click', ()=> { revPage++; renderRevPage(); });

  /* ----------------- Helpers & initial render ----------------- */
  function rebuildPoolAndUI(){ rebuildPool(); renderCurrent(); renderRevPage(); updateSessionUI(); }
  function renderCurrent(){ /* wrapper to avoid duplicate name issues */ renderCurrentInternal(); }
  function renderCurrentInternal(){
    // reuse earlier renderCurrent function
    if(pool.length === 0){
      displayWord.textContent = 'No words loaded. Please upload CSV.';
      displayMeaning.textContent = '';
      actionArea.innerHTML = '';
      typingBox.style.display = 'none';
      updateSessionUI();
      return;
    }
    if(idx >= pool.length){
      displayWord.textContent = 'Session finished 🎉';
      displayMeaning.textContent = '';
      actionArea.innerHTML = `<div style="text-align:center"><button class="btn" id="restartBtn">Restart</button></div>`;
      typingBox.style.display = 'none';
      document.getElementById('restartBtn').addEventListener('click', ()=> { idx = 0; sessionCorrect = 0; renderCurrent(); });
      updateSessionUI();
      return;
    }
    // show word
    const w = pool[idx];
    if(mode === 'type') displayWord.textContent = w.English || '[missing English]';
    else displayWord.textContent = ((w.Article||'').trim() ? (w.Article + ' ') : '') + w.German;
    displayMeaning.textContent = '';
    actionArea.innerHTML = '';
    typingBox.style.display = (mode === 'type') ? 'block' : 'none';
    typingInput.value = '';
    typingFeedback.textContent = '';
    updateSessionUI();
    if(mode === 'flash') renderFlash(w);
    if(mode === 'mcq') renderMCQ(w);
    if(mode === 'type') renderType(w);
  }

  function updateSessionUI(){ // safe updater used elsewhere
    const total = pool.length;
    const pct = total ? Math.round((sessionCorrect / total) * 100) : 0;
    sessionProgress.style.width = pct + '%';
    sessionText.textContent = `${Math.min(idx,total)} / ${total} • ✓ ${sessionCorrect}`;
    mainProgress.style.width = pct + '%';
    progressText.textContent = `${Math.min(idx,total)} / ${total} • ✓ ${sessionCorrect}`;
    currentLevelBadge.textContent = levelSelect.value || 'ALL';
  }

  // ensure initial UI correct
  rebuildPool();
  renderRevPage();
  updateSessionUI();

  /* ----------------- Contact handlers ----------------- */
  contactSave.addEventListener('click', ()=>{
    const name = contactName.value.trim();
    const email = contactEmail.value.trim();
    const message = contactMessage.value.trim();
    if(!name || !email || !message){ contactStatus.textContent = 'Fill all fields'; return; }
    const msgs = loadJSON(LS_MESSAGES, []);
    msgs.push({id: uid(), name, email, message, created: new Date().toISOString()});
    saveJSON(LS_MESSAGES, msgs);
    contactStatus.textContent = 'Saved locally. Connect EmailJS later to send.';
    contactName.value = contactEmail.value = contactMessage.value = '';
  });

  contactSend.addEventListener('click', ()=>{
    // placeholder: same as save
    contactSave.click();
  });

  /* ----------------- Small helpers exposed ----------------- */
  window.vocabApp = { allWords, rebuildPool, renderRevPage, saveAll, loadJSON };

  /* scroll helper */
  function scrollToSection(id){ const el = document.getElementById(id); if(el) el.scrollIntoView({behavior:'smooth'}); }
  window.scrollToSection = scrollToSection;
  </script>
</body>
</html>
